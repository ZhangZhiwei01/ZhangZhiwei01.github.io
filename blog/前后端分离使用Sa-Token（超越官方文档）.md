ç‚¹å‡»è¿”å›[ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•](https://percheung.github.io/#/toc)
* ç›®å½•
{:toc}
<div onclick="window.scrollTo({top:0,behavior:'smooth'});" style="background-color:white;position:fixed;bottom:20px;right:40px;padding:10px 10px 5px 10px;cursor:pointer;z-index:10;border-radius:13%;box-shadow:0.5px 3px 7px rgba(0,0,0,0.3);"><img src="https://percheung.github.io/blogImg/backTop.png" alt="TOP" style="background-color:white;width:30px;"></div>

# å‰åç«¯åˆ†ç¦»ä½¿ç”¨<img src="https://percheung.github.io/blogImg/sa-token.png" width="70px" alt="sa-token" />Sa-Tokenï¼ˆè¶…è¶Šå®˜æ–¹æ–‡æ¡£ï¼‰

## å‰è¨€

Sa-Tokençš„å®˜æ–¹æ–‡æ¡£é“¾æ¥[ğŸ”—https://sa-token.cc/doc.html](https://sa-token.cc/doc.html)åœ¨æ­¤ã€‚

**äº‹å…ˆå£°æ˜**ï¼Œèµ·ä¸€ä¸ªè¿™æ ·çš„æ ‡é¢˜å¹¶ä¸æ˜¯æˆ‘ç‹‚å¦„è‡ªå¤§ï¼Œè€Œä¸”Sa-Tokençš„å®˜æ–¹æ–‡æ¡£æ˜¯æˆ‘è§è¿‡çš„å°‘æœ‰çš„å†™çš„å¾ˆå¥½çš„å®˜æ–¹æ–‡æ¡£ï¼ˆå¾ˆå¤šçŸ¥åé¡¹ç›®çš„å®˜æ–¹æ–‡æ¡£å¯ä»¥è¯´ä¸€è¨€éš¾å°½ï¼‰ã€‚ä½†æ˜¯ï¼Œå…³äºå‰åç«¯åˆ†ç¦»çš„è¿™éƒ¨åˆ†ï¼Œæˆ‘æ„Ÿåˆ°Sa-Tokenå®˜æ–¹æ–‡æ¡£å®åœ¨æœ‰äº›è¿‡äºç®€ç•¥ã€‚è€Œæˆ‘åœ¨å­¦ä¹ Sa-Tokençš„æ—¶å€™ä¹Ÿé‡åˆ°ä¸€ä¸ªå›°å¢ƒï¼Œå°±æ˜¯å…³äºå‰åç«¯åˆ†ç¦»çš„æ–‡ç« åœ¨ç™¾åº¦è°·æ­Œä¸ŠåŸºæœ¬æ‰¾ä¸æ¥ï¼Œå¤§éƒ¨åˆ†æ‰€è°“åŸåˆ›éƒ½æ˜¯å¯¹å®˜æ–¹æ–‡æ¡£çš„å¤åˆ¶ç²˜è´´ï¼Œç…§æ¬ã€‚å› æ­¤ï¼Œåœ¨æˆ‘æŒæ¡å‰åç«¯åˆ†ç¦»å¯¹Sa-Tokençš„ä½¿ç”¨åï¼Œæˆ‘å†³å®šå†™è¿™æ ·ä¸€ç¯‡æ–‡ç« ï¼Œæ–¹ä¾¿åæ¥è€…å¯¹Sa-Tokençš„å‰åç«¯åˆ†ç¦»çš„ä½¿ç”¨æœ‰ä¸€ä¸ªå‚è€ƒã€‚

åœ¨**å‰åç«¯åˆ†ç¦»**çš„æƒé™éªŒè¯ï¼Œç™»å½•æ ¡éªŒè¿™æ¡è·¯ä¸Šã€‚æˆ‘è‡ªå­¦ä¹ ç¼–ç¨‹ä»¥æ¥ï¼Œå…ˆåç»å†è¿‡ä¼ ç»Ÿtokenï¼Œjwtï¼Œå•ç‚¹ç™»å½•ï¼Œshiroï¼ŒSpring Securityç­‰ã€‚è¿™äº›æŠ€æœ¯ï¼Œæœ‰çš„éœ€è¦ä½ ä¹¦å†™å¤§ç¯‡å¹…çš„æ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ï¼Œèµ„æºç±»æ§åˆ¶é€»è¾‘ã€‚å¯è°“è‹¦ä¸å ªè¨€ã€‚è€Œä¸”å®˜æ–¹æ–‡æ¡£ä¸€å¡Œç³Šæ¶‚ï¼Œä½¿ç”¨æ­¥éª¤æåº¦ç¹çã€‚æœ€ç»ˆï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªç›®å‰æˆ‘è®¤ä¸ºæœ€å®Œç¾çš„æŠ€æœ¯ï¼šSa-Tokenã€‚å½“ä»Šå›½å†…ä¼ä¸šï¼Œå¤§éƒ¨åˆ†é¡¹ç›®éƒ½æ˜¯å‰åç«¯åˆ†ç¦»çš„ï¼ŒSa-Tokenç¾ä¸­ä¸è¶³çš„åœ°æ–¹åœ¨äºï¼Œå®ƒçš„å®˜æ–¹æ–‡æ¡£å¯¹å‰åç«¯ä¸åˆ†ç¦»çš„éƒ¨åˆ†è®²è¿°çš„å¾ˆæ¸…æ¥šï¼Œå¯¹æˆ‘ä»¬çœŸæ­£è¦ç»å¸¸ç”¨åˆ°å‰åç«¯åˆ†ç¦»çš„ä½¿ç”¨è®²è¿°çš„å´è¿‡äºç®€ç•¥ã€‚è¿™ç¯‡æ–‡æ¡£ï¼Œæˆ‘å°†ä»å¤´åˆ°å°¾è®²è§£å¦‚ä½•ä½¿ç”¨Sa-Tokenåšå‰åç«¯åˆ†ç¦»çš„**Spring Boot**é¡¹ç›®ã€‚

è¯·æ³¨æ„ï¼Œå¤§éƒ¨åˆ†ä»£ç éœ€è¦ä½ ç»“åˆå®é™…ï¼Œç”šè‡³éœ€è¦ä½ ç¨åŠ æ”¹åŠ¨æ‰èƒ½ç”¨ã€‚æˆ‘ä¼šé»˜è®¤ä½ å·²ç»æŒæ¡äº†jwtï¼Œcookieï¼Œsessionç­‰çŸ¥è¯†ã€‚æˆ‘å°†åœ¨æ¯ä¸€æ®µä»£ç å†…å†™ä¸Šæ³¨é‡Šï¼Œè€Œä¸”è®²è§£æˆ‘çš„å†™ä½œé€»è¾‘ï¼Œä½†è¿™ä¸æ„å‘³ç€ä½ å¯ä»¥ä¸æ€è€ƒå°±èƒ½æŒæ¡è¿™é¡¹æŠ€æœ¯ã€‚æˆ‘å·²ç»å°†æˆ‘çš„ä»£ç å¼€æºæ”¾åœ¨githubï¼Œä½ ä¹Ÿå¯ä»¥æ‹‰å–GitHubçš„ä»£ç åœ¨æœ¬åœ°è¿è¡Œï¼Œæ›´æ–¹ä¾¿ä½ ç†è§£è¿™é¡¹æŠ€æœ¯ã€‚**GitHub**çš„é“¾æ¥[ğŸ”—https://github.com/PerCheung/learnsatoken](https://github.com/PerCheung/learnsatoken)åœ¨æ­¤ã€‚

## æ­¥éª¤

### 1.åˆ›å»ºä¸€ä¸ªspring booté¡¹ç›®ï¼Œå¼•å…¥å¦‚ä¸‹ä¸¤ä¸ªä¾èµ–ã€‚

```xml
        <!-- Sa-Token æƒé™è®¤è¯ï¼Œåœ¨çº¿æ–‡æ¡£ï¼šhttps://sa-token.cc -->
        <dependency>
            <groupId>cn.dev33</groupId>
            <artifactId>sa-token-spring-boot-starter</artifactId>
            <version>1.35.0.RC</version>
        </dependency>
        <!-- Sa-Token æ•´åˆ Redis ï¼ˆä½¿ç”¨ jackson åºåˆ—åŒ–æ–¹å¼ï¼‰ -->
        <dependency>
            <groupId>cn.dev33</groupId>
            <artifactId>sa-token-redis-jackson</artifactId>
            <version>1.35.0.RC</version>
        </dependency>
```
è®²è§£ï¼šç¬¬ä¸€ä¸ªæ˜¯sa-tokençš„è‡ªåŠ¨è£…é…ï¼Œæ— éœ€å¤šè¨€ã€‚ç¬¬äºŒä¸ªï¼Œåˆ™ä¼šå°†æˆ‘ä»¬çš„tokenè‡ªåŠ¨ç®¡ç†åœ¨redisä¸­ï¼Œè€Œä¸æ˜¯åœ¨cookieæˆ–è€…sessionï¼Œè¿™æ ·å°±è¾¾åˆ°äº†æœ€å®Œç¾çš„å‰åç«¯åˆ†ç¦»çŠ¶æ€ï¼Œæ— è®ºä½ æ˜¯é‡å¯å‰ç«¯è¿˜æ˜¯åç«¯ï¼Œé”€æ¯cookieè¿˜æ˜¯sessionï¼Œéƒ½ä¸å½±å“é¡¹ç›®çš„tokenã€‚å¦‚æœä½ å¯¹å•ç‚¹ç™»å½•ï¼Œåˆ†å¸ƒå¼ç™»å½•æœ‰äº†è§£ï¼Œä½ å°±ä¼šæ·±æ·±æ˜ç™½è¿™ä¹ˆåšçš„å¥½å¤„ã€‚åœ¨è·¨åŸŸçš„å•ç‚¹ç™»å½•é‡Œï¼Œcookieæ˜¯å¤±æ•ˆçš„ï¼Œå‰åç«¯åˆ†ç¦»ï¼Œåˆ†å¸ƒå¼çš„é¡¹ç›®é‡Œï¼Œä¸€ä¸ªè¯·æ±‚æ ¹æœ¬ä¸çŸ¥é“åˆ°æ¥çš„è¯·æ±‚åœ¨è·Ÿå“ªä¸ªsessionæ‰“äº¤é“ã€‚**æˆ‘çš„ä»£ç åªæ±‚æœ€å½»åº•ï¼Œæœ€æ¿€è¿›ï¼Œæœ€å®Œå–„çš„å‰åç«¯åˆ†ç¦»**ã€‚
### 2.é…ç½®ä½ çš„application.yml

> è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåœ¨spring boot data redisçš„2ç‰ˆæœ¬ä»¥åï¼Œå·²ç»å¼ƒç”¨ jedis æ”¹ç”¨ lettuceï¼Œè€Œå®˜ç½‘ä»åœ¨é…ç½®jedisè¿æ¥æ± ï¼Œè¿™é‡Œè¦ç”¨lettuceè¿æ¥æ± ã€‚

```yaml
############## Sa-Token é…ç½® (æ–‡æ¡£: https://sa-token.cc) ##############
sa-token:
  # token åç§°ï¼ˆåŒæ—¶ä¹Ÿæ˜¯ cookie åç§°ï¼‰
  token-name: token
  # token æœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰ é»˜è®¤30å¤©ï¼Œ-1 ä»£è¡¨æ°¸ä¹…æœ‰æ•ˆ
  timeout: -1
  # token æœ€ä½æ´»è·ƒé¢‘ç‡ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œå¦‚æœ token è¶…è¿‡æ­¤æ—¶é—´æ²¡æœ‰è®¿é—®ç³»ç»Ÿå°±ä¼šè¢«å†»ç»“ï¼Œé»˜è®¤-1 ä»£è¡¨ä¸é™åˆ¶ï¼Œæ°¸ä¸å†»ç»“
  active-timeout: -1
  # æ˜¯å¦å…è®¸åŒä¸€è´¦å·å¤šåœ°åŒæ—¶ç™»å½• ï¼ˆä¸º true æ—¶å…è®¸ä¸€èµ·ç™»å½•, ä¸º false æ—¶æ–°ç™»å½•æŒ¤æ‰æ—§ç™»å½•ï¼‰
  is-concurrent: false
  # token é£æ ¼ï¼ˆé»˜è®¤å¯å–å€¼ï¼šuuidã€simple-uuidã€random-32ã€random-64ã€random-128ã€tikï¼‰
  token-style: simple-uuid
  # æ˜¯å¦è¾“å‡ºæ“ä½œæ—¥å¿—
  is-log: true
  # æ˜¯å¦å°è¯•ä» cookie é‡Œè¯»å– Tokenï¼Œæ­¤å€¼ä¸º false åï¼ŒStpUtil.login(id) ç™»å½•æ—¶ä¹Ÿä¸ä¼šå†å¾€å‰ç«¯æ³¨å…¥Cookie
  isReadCookie: false
spring:
  # Redisé…ç½®
  redis:
    host: localhost
    port: 6379
    # æ ¹æ®è‡ªå·±è®¾ç½®çš„å¯†ç å†³å®š
    password: ä½ çš„rediså¯†ç 
    # æ“ä½œ0å·æ•°æ®åº“ï¼Œé»˜è®¤æœ‰16ä¸ªæ•°æ®åº“
    database: 0
    lettuce:
      pool:
        # æœ€å¤§è¿æ¥æ•°
        max-active: 500
        # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´
        max-wait: 1000ms
        # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
        max-idle: 100
        # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
        min-idle: 0
```

è®²è§£ï¼šå¦‚æœä½ ç”¨è¿‡jwtï¼Œé‚£ä¹ˆ**token-name: token**å°±å¯ä»¥è¾¾åˆ°ç±»ä¼¼äºjwtçš„æ•ˆæœï¼Œåœ¨ä½ çš„headeråŠ ä¸Š**token:tokenå€¼**ï¼Œå°±å¯ä»¥è¾¾åˆ°ç™»å½•çš„æ ¡éªŒçš„æ•ˆæœï¼Œåƒjwtä¸€æ ·ï¼Œå®Œå…¨æŠ›å¼ƒäº†cookieå’Œsessionï¼Œè€Œjwtè¿‡äºå†—ä½™ï¼Œ**token-style: simple-uuid**å°†ä¿è¯tokençš„ç²¾ç®€ï¼Œç»“åˆtokençš„å”¯ä¸€æ€§é…åˆredisçš„ä½¿ç”¨ï¼Œjwtæºå¸¦ä¿¡æ¯çš„ä¼˜ç‚¹ä¹Ÿå°†ä¸å¤å­˜åœ¨ï¼Œå› ä¸ºrediså¯ä»¥å­˜å‚¨ä¸€åˆ‡ã€‚è€Œredisé…ç½®ä½ ä¸å¿…æ‹…å¿ƒå®ƒå½±å“spring bootè‡ªå¸¦çš„redisè‡ªåŠ¨è£…é…ä¾èµ–ï¼Œç»“åˆå®é™…ä½ ä¼šå‘ç°sa-tokenå°±æ˜¯å°è£…çš„redisè‡ªåŠ¨è£…é…ä¾èµ–ã€‚å½“ä½ åˆ›é€ ä¸€ä¸ªtokenï¼Œä»–ä¹Ÿä¼šè‡ªåŠ¨å†™å…¥redisï¼Œä¸éœ€è¦ä½ å¤šå†™ä»»ä½•ä»£ç ã€‚æ‰€æœ‰çš„tokenï¼Œéƒ½å°†ä¼šè‡ªåŠ¨ç®¡ç†ã€‚

### 3.æ³¨è§£é‰´æƒ

åŠ sa-tokenæ‹¦æˆªå™¨ã€‚

```java
import cn.dev33.satoken.interceptor.SaInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * @author Peter Cheung
 * 2023/7/19 13:52
 */
@Configuration
public class SaTokenConfigure implements WebMvcConfigurer {
    // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
        registry.addInterceptor(new SaInterceptor()).addPathPatterns("/api/**");
    }
}
```
è®²è§£ï¼š/apiæœ€å¥½å†™ä¸Šï¼Œç„¶åæŠŠä½ çš„æ¥å£éƒ½å¸¦ä¸Š/apiï¼Œå› ä¸º/**ä»€ä¹ˆéƒ½æ‰«æï¼Œæ•ˆç‡ä½ä¸‹ã€‚**å¦‚æœä½ åªåšç™»å½•æ ¡éªŒï¼Œè¿™ä¹ˆç‚¹ä»£ç å°±å·²ç»è¶³å¤Ÿã€‚**

å¦‚æœä½ è¿˜æƒ³åšæƒé™ï¼Œè§’è‰²çš„æ ¡éªŒï¼ŒåŠ ä¸Šä¸‹é¢çš„ä»£ç ã€‚

```java
import cn.dev33.satoken.stp.StpInterface;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

/**
 * @author Peter Cheung
 * 2023/7/19 16:55
 */
@Service
public class StpInterfaceImpl implements StpInterface {

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢æƒé™
        List<String> list = new ArrayList<String>();
        list.add("101");
        list.add("user.add");
        list.add("user.update");
        list.add("user.get");
        // list.add("user.delete");
        list.add("art.*");
        return list;
    }

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢è§’è‰²
        List<String> list = new ArrayList<String>();
        if ("root".equals(loginId)) {
            list.add("admin");
            list.add("super-admin");
        }
        return list;
    }
}

```
è®²è§£ï¼šå…·ä½“ç”¨æ³•æˆ‘ä¸å†èµ˜è¿°ï¼Œå¦‚æœä½ å­¦è¿‡shiroï¼Œé‚£ä½ ç†è§£è¿™æ®µä»£ç è½»è€Œæ˜“ä¸¾ï¼Œæ— éæ˜¯æŠŠä¸€ä¸ªè§’è‰²æ•°ç»„æˆ–è€…æƒé™æ•°æ®ï¼Œè·Ÿè´¦å·åšäº†ä¸€ä¸ªç»‘å®šã€‚å¦‚æœä½ çœŸçš„æƒ³ç†è§£æŒæ¡ï¼Œç„¶åè¶…è¶Šï¼Œå»æ”¹é€ è¿™æ®µä»£ç ï¼Œéœ€è¦ä½ ä¸å¾—ä¸å»å­¦ä¹ ä¸€ä¸‹shiroçš„äº”è¡¨æ€æƒ³å»åˆ†é…è§’è‰²å’Œæƒé™èµ„æºã€‚æ‰èƒ½è®©ä½ çœŸæ­£åœ¨å®é™…å·¥ä½œé‡Œæ‹¿æå¯¹æƒé™è§’è‰²çš„åˆ†é…ç®¡ç†ã€‚

### 4.åŠ å…¥RedisConfig

è¿™å’Œsa-tokenæ— å…³ï¼Œåªæ˜¯ä¸ºäº†è®©ä½ çš„redisèƒ½æ”¯æŒä¸­æ–‡å­˜å‚¨ã€‚

```java
import org.springframework.cache.annotation.CachingConfigurerSupport;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

/**
 * Redisé…ç½®ç±»ï¼Œæ›´æ¢é»˜è®¤åºåˆ—åŒ–å™¨
 *
 * @author Peter Cheung
 * @since 2023-07-28 13:51:55
 */
@Configuration
public class RedisConfig extends CachingConfigurerSupport {
    /**
     * åˆ›å»º RedisTemplate Beanï¼Œç”¨äºæ“ä½œ Redis æ•°æ®åº“ã€‚
     *
     * @param connectionFactory Redis è¿æ¥å·¥å‚
     * @return RedisTemplate å®ä¾‹
     */
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        // è®¾ç½® RedisTemplate çš„è¿æ¥å·¥å‚
        redisTemplate.setConnectionFactory(connectionFactory);
        // åˆ›å»º StringRedisSerializer å®ä¾‹ï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ– Redis çš„é”®å’Œå“ˆå¸Œé”®
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        // åˆ›å»º GenericJackson2JsonRedisSerializer å®ä¾‹ï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ– Redis çš„å€¼å’Œå“ˆå¸Œå€¼
        GenericJackson2JsonRedisSerializer genericJackson2JsonRedisSerializer = new GenericJackson2JsonRedisSerializer();
        // è®¾ç½®é»˜è®¤åºåˆ—åŒ–å™¨ä¸º StringRedisSerializer
        redisTemplate.setDefaultSerializer(stringRedisSerializer);
        // è®¾ç½® RedisTemplate çš„é”®åºåˆ—åŒ–å™¨ä¸º StringRedisSerializer
        redisTemplate.setKeySerializer(stringRedisSerializer);
        // è®¾ç½® RedisTemplate çš„å“ˆå¸Œé”®åºåˆ—åŒ–å™¨ä¸º StringRedisSerializer
        redisTemplate.setHashKeySerializer(stringRedisSerializer);
        // è®¾ç½® RedisTemplate çš„å€¼åºåˆ—åŒ–å™¨ä¸º GenericJackson2JsonRedisSerializer
        redisTemplate.setValueSerializer(genericJackson2JsonRedisSerializer);
        // è®¾ç½® RedisTemplate çš„å“ˆå¸Œå€¼åºåˆ—åŒ–å™¨ä¸º GenericJackson2JsonRedisSerializer
        redisTemplate.setHashValueSerializer(genericJackson2JsonRedisSerializer);
        return redisTemplate;
    }
}

```

### 5.å¼‚å¸¸ç»Ÿä¸€å¤„ç†

å¦‚æœä½ çš„JavaçŸ¥è¯†ä¸è¶³ä»¥ç†è§£è¿™äº›ä»£ç ï¼Œè¿™äº›ä¹Ÿå¯ä»¥ä¸è¦ï¼Œä¸‹é¢çš„ä»£ç åªæ˜¯ä¸ºäº†è®©ä½ é”™è¯¯å¤„ç†æ›´åŠ ä¼˜é›…ã€‚

```java
import javax.validation.ValidationException;
import java.io.ByteArrayOutputStream;
import java.io.PrintStream;

import static com.learn.learnsatoken.config.constant.Constant.PACKAGE_NAME;

/**
 * å…¨å±€å¼‚å¸¸ç»Ÿä¸€å¤„ç†
 *
 * @author Peter Cheung
 * @since 2023-07-19 11:37:24
 */
@Slf4j
@ControllerAdvice
@ResponseBody
public class AllExceptionHandle {
    /**
     * ç™»å½•æƒé™æ ¡éªŒ
     */
    @ExceptionHandler({NotLoginException.class, NotRoleException.class})
    public ResponseEntity<R> unauthorized(Exception e) {
        return R.deal(R.unauthorized().data(e(e)));
    }

    /**
     * æ ¡éªŒä¼ å‚
     */
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<R> handleBadRequest(Exception e) {
        return R.deal(R.badRequest().data(e(e)));
    }

    /**
     * å…¨å±€å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<R> exception(Exception e) {
        return R.deal(R.exp().data(e(e)));
    }

    /**
     * å¼‚å¸¸ä¿¡æ¯å¤„ç†ä¸»ä½“æ–¹æ³•
     *
     * @param e å¼‚å¸¸å¯¹è±¡
     * @return å¼‚å¸¸è§£æä¿¡æ¯
     */
    private String e(Exception e) {
        ByteArrayOutputStream printStackTrace = new ByteArrayOutputStream();
        e.printStackTrace(new PrintStream(printStackTrace));
        log.error(String.valueOf(printStackTrace));
        //é”™è¯¯ä¿¡æ¯
        StringBuilder errorMessage = new StringBuilder();
        errorMessage.append(e);
        if (StringUtils.isBlank(e.getMessage())) {
            //å¤„ç†
            log.error(String.valueOf(errorMessage));
            return String.valueOf(errorMessage);
        }
        StackTraceElement[] stackTrace = e.getStackTrace();
        for (StackTraceElement stackTraceElement : stackTrace) {
            String className = stackTraceElement.getClassName();
            if (className.startsWith(PACKAGE_NAME)) {
                String errorName = ";" + stackTraceElement.getClassName();
                errorMessage.append(errorName);
                String errorLineNumber = ":" + stackTraceElement.getLineNumber();
                errorMessage.append(errorLineNumber);
                //å¤„ç†
                log.error(String.valueOf(errorMessage));
                return String.valueOf(errorMessage);
            }
        }
        //å¤„ç†
        log.error(String.valueOf(errorMessage));
        return String.valueOf(errorMessage);
    }
}
```

ä½ åªéœ€å…³æ³¨çš„ä»£ç æ˜¯è¿™ä¸€æ®µã€‚

```java
    /**
     * ç™»å½•æƒé™æ ¡éªŒ
     */
    @ExceptionHandler({NotLoginException.class, NotRoleException.class})
    public ResponseEntity<R> unauthorized(Exception e) {
        return R.deal(R.unauthorized().data(e(e)));
    }
```
è®²è§£ï¼šç™»å½•ï¼Œæƒé™çš„ä¸è¶³ï¼Œéƒ½å¯ä»¥ç†è§£æˆ401é”™è¯¯ï¼Œè¿™æ˜¯httpçš„çŸ¥è¯†ï¼Œè¿™æ®µä»£ç å°†ä¼šæŠŠsa-tokençš„æŠ¥é”™éƒ½ä»¥401é”™è¯¯è¿”å›ç»™å‰ç«¯ï¼Œè®©å‰ç«¯ä¸€çœ‹ä¾¿çŸ¥ï¼š**å“¦ï¼ŒåŸæ¥æ˜¯ç”¨æˆ·çš„é—®é¢˜ï¼Œä¸æ˜¯åç«¯é”™äº†ã€‚**

### 6.ä¸šåŠ¡ä»£ç controllerå±‚

```java
import cn.dev33.satoken.annotation.SaCheckBasic;
import cn.dev33.satoken.annotation.SaCheckLogin;
import cn.dev33.satoken.annotation.SaCheckRole;
import cn.dev33.satoken.stp.StpUtil;
import cn.dev33.satoken.util.SaResult;
import com.learn.learnsatoken.mvc.domain.User;
import com.learn.learnsatoken.mvc.service.UserService;
import com.learn.learnsatoken.util.MD5Util;
import com.learn.learnsatoken.util.R;
import com.learn.learnsatoken.util.UUIDUtil;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;

/**
 * ç”¨æˆ·è¡¨(User)è¡¨æ§åˆ¶å±‚
 *
 * @author Peter Cheung
 * @since 2023-07-19 11:37:23
 */
@CrossOrigin(origins = "*", methods = {RequestMethod.GET, RequestMethod.POST, RequestMethod.PUT, RequestMethod.DELETE, RequestMethod.HEAD})
@Slf4j
@RestController
@RequestMapping("api/user")
@Api(tags = "ç”¨æˆ·è¡¨(User)è¡¨æ§åˆ¶å±‚")
public class UserController {
    /**
     * æœåŠ¡å¯¹è±¡
     */
    @Resource
    private UserService userService;

    @Resource
    private RedisTemplate<String, String> redisTemplate;

    /**
     * æ³¨å†Œ
     */
    @GetMapping("register")
    public ResponseEntity<R> register(User user) {
        String password = user.getPassword();
        String salt = UUIDUtil.toUUID();
        user.setSalt(salt);
        user.setPassword(MD5Util.toMD5(password, salt));
        return R.deal(this.userService.insert(user));
    }

    @GetMapping("login")
    public ResponseEntity<R> doLogin(User user) {
        String username = user.getUsername();
        User data = (User) userService.queryById(username).getData();
        if (data == null) {
            return R.deal(R.unauthorized().data("no user"));
        }
        if (data.getPassword().equals(MD5Util.toMD5(user.getPassword(), data.getSalt()))) {
            StpUtil.login(username);
            return R.deal(R.ok().data(StpUtil.getTokenInfo().getTokenValue()));
        }
        return R.deal(R.unauthorized().data("wrong password"));
    }

    @GetMapping("logout")
    public SaResult logout(String name, String token) {
        redisTemplate.opsForValue().set("æœ€è¿‘äº”åˆ†é’Ÿè®¿é—®çš„ip", "æˆ‘æ˜¯ï¼Ÿ123456", 5, TimeUnit.MINUTES);
        //StpUtil.logout(name);
        StpUtil.logoutByTokenValue(token);
        return SaResult.ok();
    }

    /**
     * å…¨æŸ¥è¯¢
     *
     * @param user ç­›é€‰æ¡ä»¶
     * @return æŸ¥è¯¢ç»“æœ
     */
    @SaCheckLogin
    @ApiOperation("å…¨æŸ¥è¯¢")
    @GetMapping
    public ResponseEntity<R> queryAll(@ApiParam(value = "user ç­›é€‰æ¡ä»¶") User user) {
        return R.deal(this.userService.queryAll(user));
    }

    @SaCheckBasic(account = "admin:admin")
    @GetMapping("basic")
    public ResponseEntity<R> basic(String token) {
        Object username = StpUtil.getLoginIdByToken(token);
        return R.deal(R.ok().data(username));
    }

    /**
     * é€šè¿‡ä¸»é”®æŸ¥è¯¢å•æ¡æ•°æ®
     *
     * @param id ä¸»é”®
     * @return å•æ¡æ•°æ®
     */
    @SaCheckRole("admin")
    @ApiOperation("é€šè¿‡ä¸»é”®æŸ¥è¯¢å•æ¡æ•°æ®")
    @GetMapping("{id}")
    public ResponseEntity<R> queryById(@ApiParam(value = "id ä¸»é”®") @PathVariable("id") String id) {
        return R.deal(this.userService.queryById(id));
    }
}
```

è®²è§£ï¼šä½ è¦æ³¨æ„åˆ°ï¼Œè¿™é‡Œé¢æœ‰å‡ ä¸ªæ³¨è§£`@SaCheckLogin`ï¼Œ`@SaCheckRole("admin")`ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ç™»å½•æ ¡éªŒï¼Œç¬¬äºŒä¸ªå°±æ˜¯adminè§’è‰²æ ¡éªŒã€‚ä½ è§‚å¯Ÿæˆ‘çš„loginéƒ¨åˆ†ã€‚`StpUtil.login(username);`è¿™å¥è¯ï¼Œå°±èƒ½ä¿è¯tokenä»¥usernameä¸ºkeyï¼Œåˆ›é€ tokenå†™å…¥rediså¹¶ä¸”ç®¡ç†èµ·æ¥ï¼Œå®Œå…¨æ— éœ€å¤ªå¤šä»£ç ã€‚è€Œ`StpUtil.getTokenInfo().getTokenValue()`å°†æŠŠtokenæ‹¿å‡ºæ¥è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯è¦è®°å¾—æŠŠtokenä¿å­˜èµ·æ¥ï¼Œæœ€å¥½æ˜¯æ”¾å‰ç«¯çš„**localStorage**ï¼ˆåç«¯ä¸æ‡‚è¿™æ˜¯ä»€ä¹ˆï¼Œå‰ç«¯å¾ˆæ‡‚ï¼‰é‡Œï¼Œåªè¦å‰ç«¯è®°å¾—åé¢ç»™å¸¦`@SaCheckLogin`è¿™æ ·çš„æ¥å£å‘è¯·æ±‚çš„æ—¶å€™ï¼ŒæŠŠtokenæ”¾headeré‡Œä¼ è¿‡æ¥å°±è¡Œã€‚

### 7.å‰ç«¯ä»£ç 

ä¸ºäº†æ–¹ä¾¿ä½ çš„ç†è§£å’Œä½¿ç”¨ï¼Œæˆ‘ç‰¹æ„å†™äº†htmlä»£ç ä¾›ä½ æµ‹è¯•ä½¿ç”¨ï¼Œä»£ç å·²ç»å†™äº†å¤§ç¯‡å¹…çš„æ³¨é‡Šï¼Œæˆ‘å°±ä¸è®²è§£äº†ã€‚

```html
<!DOCTYPE html>
<html>
<head>
	<title>My Page</title>
	<meta charset="UTF-8">
	<!-- å¼•ç”¨jQueryåº“ -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		$(document).ready(function() {
			// å½“é¡µé¢åŠ è½½å®Œæˆæ—¶æ‰§è¡Œä»¥ä¸‹ä»£ç 
			$("#login").click(function() {
				// å½“â€œLoginâ€æŒ‰é’®è¢«ç‚¹å‡»æ—¶æ‰§è¡Œä»¥ä¸‹ä»£ç 
				var username = $("#username").val(); // è·å–è¾“å…¥æ¡†ä¸­çš„ç”¨æˆ·å
				var password = $("#password").val(); // è·å–è¾“å…¥æ¡†ä¸­çš„å¯†ç 
				var url = "http://localhost:8081/api/user/login?username=" + username + "&password=" + password; // æ„é€ ç”¨äºç™»å½•çš„URL
				$.get(url, function(data) { // å‘é€GETè¯·æ±‚
					if (data.code == 200) { // å¦‚æœè¿”å›ç ä¸º200åˆ™è¡¨ç¤ºç™»å½•æˆåŠŸ
						localStorage.setItem("token", data.data); // å°†tokenä¿å­˜åˆ°localStorageä¸­
						alert("Login successful!"); // å¼¹å‡ºç™»å½•æˆåŠŸæç¤ºæ¡†
					} else {
						alert("Login failed: " + data.msg); // å¼¹å‡ºç™»å½•å¤±è´¥æç¤ºæ¡†
					}
				});
			});

			$("#get-data").click(function() {
				// å½“â€œGet Dataâ€æŒ‰é’®è¢«ç‚¹å‡»æ—¶æ‰§è¡Œä»¥ä¸‹ä»£ç 
				var token = localStorage.getItem("token"); // è·å–localStorageä¸­ä¿å­˜çš„token
				if (token == null || token == "") {
					alert("Please login first!"); // å¦‚æœtokenä¸ºç©ºåˆ™è¡¨ç¤ºæœªç™»å½•ï¼Œå¼¹å‡ºæç¤ºæ¡†
					return;
				}
				var url = "http://localhost:8081/api/user"; // æ„é€ è¯·æ±‚æ•°æ®çš„URL
				$.ajax({
					url: url,
					type: "GET",
					headers: {
						"token": token // åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ token
					},
					success: function(data) { // è¯·æ±‚æˆåŠŸå›è°ƒå‡½æ•°
						$("#result").val(JSON.stringify(data)); // å°†è¿”å›çš„æ•°æ®å±•ç¤ºåˆ°æ–‡æœ¬æ¡†ä¸­
					},
					error: function(xhr, status, error) { // è¯·æ±‚å¤±è´¥å›è°ƒå‡½æ•°
						alert("Error: " + error); // å¼¹å‡ºé”™è¯¯æç¤ºæ¡†
					}
				});
			});
		});
	</script>
</head>
<body>
	<h1>Welcome to My Page</h1>
	<form>
		<label for="username">Username:</label>
		<input type="text" name="username" id="username"><br><br>
		<label for="password">Password:</label>
		<input type="password" name="password" id="password"><br><br>
		<input type="button" value="Login" id="login"> <!-- ç‚¹å‡»è¯¥æŒ‰é’®å‘èµ·ç™»å½•è¯·æ±‚ -->
	</form>
	<br>
	<textarea id="result" rows="10" cols="50"></textarea><br>
	<input type="button" value="Get Data" id="get-data"> <!-- ç‚¹å‡»è¯¥æŒ‰é’®å‘èµ·è·å–æ•°æ®è¯·æ±‚ -->
</body>
</html>
```
## ç»“è¯­

ä»¥ä¸Šå°±æ˜¯ç²¾åå†…å®¹ï¼Œå¦‚æœä½ ä¸å¤ªç†è§£ï¼Œè¿˜æ˜¯å»ºè®®ä½ ï¼ŒæŠŠGitHubä¸Šçš„ä»£ç [ğŸ”—https://github.com/PerCheung/learnsatoken](https://github.com/PerCheung/learnsatoken)æ‹‰ä¸‹æ¥å®æ“ä¸€éã€‚å…‰çœ‹ä¸å¦‚ä¸Šæ‰‹åšä¸€éã€‚å¯¹äº†ï¼Œæˆ‘çš„userè¡¨sqlå¦‚ä¸‹ã€‚å¦‚æœä½ æƒ³è¦äº†è§£shiroäº”è¡¨çš„ä½¿ç”¨ï¼Œæ–¹ä¾¿ä½ ç†è§£sa-tokenå¯¹æƒé™çš„ç®¡ç†ï¼Œæˆ‘ä¹Ÿæœ‰shiroçš„å¼€æºé¡¹ç›®é“¾æ¥[ğŸ”—https://github.com/PerCheung/learnshiro](https://github.com/PerCheung/learnshiro)ã€‚

```sql
drop database shiro_learn;

create database shiro_learn;

use shiro_learn;

create table user
(
    username    varchar(36) primary key comment 'ç”¨æˆ·å',
    password    varchar(32) not null comment 'å¯†ç ',
    salt        varchar(36) not null comment 'ç›',
    create_time datetime default now() comment 'åˆ›å»ºæ—¶é—´',
    update_time datetime default now() comment 'ä¿®æ”¹æ—¶é—´',
    deleted     int      default 0 comment 'é€»è¾‘åˆ é™¤'
) comment 'ç”¨æˆ·è¡¨'
    engine = innodb
    default charset = utf8mb4;

create trigger user_update
    before update
    on user
    for each row set new.update_time = now();
```
